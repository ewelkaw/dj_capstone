apiVersion: v1
kind: Service
metadata: {name: postgres, namespace: app}
spec:
  ports: [{name: pg, port: 5432, targetPort: 5432}]
  selector: {app: postgres}
---
apiVersion: apps/v1
kind: StatefulSet
metadata: {name: postgres, namespace: app}
spec:
  serviceName: postgres
  replicas: 1
  selector: {matchLabels: {app: postgres}}
  template:
    metadata: {labels: {app: postgres}}
    spec:
      containers:
      - name: pg
        image: postgres:16
        ports: [{name: pg, containerPort: 5432}]
        env:
          - name: POSTGRES_DB
            valueFrom: {secretKeyRef: {name: db, key: DB_NAME}}
          - name: POSTGRES_USER
            valueFrom: {secretKeyRef: {name: db, key: DB_USER}}
          - name: POSTGRES_PASSWORD
            valueFrom: {secretKeyRef: {name: db, key: DB_PASSWORD}}
        readinessProbe: {tcpSocket: {port: 5432}, initialDelaySeconds: 5, periodSeconds: 5}
